<!doctype html>
<notebook theme="glacier">
  <title>Comunas de origen de estudiantes universitarios</title>
  <script id="1" type="text/markdown">
    # Comunas de origen de estudiantes universitarios
  </script>
  <script id="2" type="application/sql" pinned="" database="duckdb">
    SELECT *
    FROM "./data/Rinden_Admisión2026/ArchivoC_Adm2026REG.csv"
      WHERE SITUACION_EGRESO = 1
    LIMIT 10
  </script>
  <script id="4" type="text/x-typescript" pinned="">
    const RBD = 5812
  </script>
  <script id="3" type="application/sql" pinned="" database="duckdb" output="dataPorRBD">
    SELECT
      dir.RBD,
      NOM_RBD,
      NOM_COM_RBD,
      COD_CARRERA_PREF,
      NOMBRE_CARRERA,
      NOMBRE_UNIVERSIDAD,
      LUGAR_IMPARTE,
      count(*) as estudiantes
    FROM "./data/Rinden_Admisión2026/ArchivoC_Adm2026REG.csv" puntaje
    LEFT JOIN "./data/Postulación_Admisión2026/ArchivoD_Adm2026REG.csv" postulacion
      ON puntaje.ID_aux = postulacion.ID_aux
    LEFT JOIN "./data/Directorio-Oficial-EE-2025/20250926_Directorio_Oficial_EE_2025_20250430_WEB.csv" dir
      ON puntaje.RBD = dir.RBD
    LEFT JOIN './data/Postulación_Admisión2026/Oferta académica.csv' oferta
     ON postulacion.COD_CARRERA_PREF = oferta.CODIGO_CARRERA
    LEFT JOIN './data/Postulación_Admisión2026/OFERTA_DEFINITIVA_PROGRAMAS_PAES_2025.csv' ofertaMineduc2025
     ON postulacion.COD_CARRERA_PREF = ofertaMineduc2025.COD_CARRERA
    WHERE
      dir.RBD = ${RBD}
      AND SITUACION_EGRESO = 1
      AND ESTADO_PREF = 24
    GROUP BY   dir.RBD,
      NOM_RBD,
      NOM_COM_RBD,
      COD_CARRERA_PREF,
      NOMBRE_CARRERA,
      NOMBRE_UNIVERSIDAD,
      LUGAR_IMPARTE
    ORDER BY count(*) DESC
  </script>
  <script id="10" type="application/sql" pinned="" database="duckdb" output="dataOfertaAcademica">
    SELECT
      CODIGO_CARRERA,
      NOMBRE_UNIVERSIDAD,
      NOMBRE_CARRERA,
      LUGAR_IMPARTE
    FROM './data/Postulación_Admisión2026/Oferta académica.csv' oferta
      LEFT JOIN './data/Postulación_Admisión2026/OFERTA_DEFINITIVA_PROGRAMAS_PAES_2025.csv' ofertaMineduc2025
     ON oferta.CODIGO_CARRERA = ofertaMineduc2025.COD_CARRERA

    ORDER BY NOMBRE_UNIVERSIDAD, NOMBRE_CARRERA
  </script>
  <script id="7" type="text/x-typescript">
    const universidad = view(Inputs.select(_.chain(dataOfertaAcademica).map(d => d.NOMBRE_UNIVERSIDAD).uniq().sort().value(), {label: "Universidad"}));

  </script>
  <script id="8" type="text/x-typescript">
    const carrera = view(Inputs.select(_.chain(dataOfertaAcademica).filter(d => d.NOMBRE_UNIVERSIDAD == universidad).uniqBy(d => d.CODIGO_CARRERA).sortBy(d => d.NOMBRE_CARRERA).value(), {label: "Carrera", format:d => d.LUGAR_IMPARTE ? `${d.NOMBRE_CARRERA} (${d.LUGAR_IMPARTE})`: `${d.NOMBRE_CARRERA} (cod. ${d.CODIGO_CARRERA})`}));

  </script>
  <script id="14" type="text/x-typescript">
    const lugar = view(Inputs.select(_.chain(dataOfertaAcademica).filter(d => d.NOMBRE_UNIVERSIDAD == universidad).uniqBy(d => d.LUGAR_IMPARTE).map(d => d.LUGAR_IMPARTE).value(), {label: "Lugar" }));

  </script>
  <script id="15" type="text/x-typescript" pinned="">
    Pack(dataUniversidadComuna, {
      path: (d) => d.NOM_COM_RBD.replaceAll(".", "/"), // e.g. flare/animate/Easing
      label: (d) => d.NOM_COM_RBD.split(".").pop(), // display text
      value: (d) => d?.estudiantes, // area of each circle
      title: (d, n) => [n.id, n.value.toLocaleString()].join("\n"), // hover text
      width,
      height: 720,
    })
  </script>
  <script id="18" type="text/x-typescript" pinned="">
    color("a")
  </script>
  <script id="17" type="text/x-typescript" pinned="">
    const color = d3.scaleOrdinal()
    .range(["blue", "red"])
  </script>
  <script id="16" type="text/x-typescript" pinned="">
    import {Pack} from "observable:@d3/pack"
  </script>
  <script id="12" type="application/sql" pinned="" database="duckdb" output="dataPorComuna">
    SELECT
      COD_CARRERA_PREF,
      NOMBRE_CARRERA,
      NOMBRE_UNIVERSIDAD,
      LUGAR_IMPARTE,
      NOM_COM_RBD,
      count(*) as estudiantes
    FROM "./data/Rinden_Admisión2026/ArchivoC_Adm2026REG.csv" puntaje
    LEFT JOIN "./data/Postulación_Admisión2026/ArchivoD_Adm2026REG.csv" postulacion
      ON puntaje.ID_aux = postulacion.ID_aux
    LEFT JOIN "./data/Directorio-Oficial-EE-2025/20250926_Directorio_Oficial_EE_2025_20250430_WEB.csv" dir
      ON puntaje.RBD = dir.RBD
    LEFT JOIN './data/Postulación_Admisión2026/Oferta académica.csv' oferta
     ON postulacion.COD_CARRERA_PREF = oferta.CODIGO_CARRERA
    LEFT JOIN './data/Postulación_Admisión2026/OFERTA_DEFINITIVA_PROGRAMAS_PAES_2025.csv' ofertaMineduc2025
     ON postulacion.COD_CARRERA_PREF = ofertaMineduc2025.COD_CARRERA
    WHERE
      COD_CARRERA_PREF = ${carrera.CODIGO_CARRERA}
      AND SITUACION_EGRESO = 1
      AND ESTADO_PREF = 24
    GROUP BY
      NOM_COM_RBD,
      COD_CARRERA_PREF,
      NOMBRE_CARRERA,
      NOMBRE_UNIVERSIDAD,
      LUGAR_IMPARTE
    ORDER BY count(*) DESC
  </script>
  <script id="13" type="application/sql" pinned="" database="duckdb" output="dataUniversidadComuna">
    SELECT

      NOMBRE_UNIVERSIDAD,
      LUGAR_IMPARTE,
      NOM_COM_RBD,
      count(*) as estudiantes
    FROM "./data/Rinden_Admisión2026/ArchivoC_Adm2026REG.csv" puntaje
    LEFT JOIN "./data/Postulación_Admisión2026/ArchivoD_Adm2026REG.csv" postulacion
      ON puntaje.ID_aux = postulacion.ID_aux
    LEFT JOIN "./data/Directorio-Oficial-EE-2025/20250926_Directorio_Oficial_EE_2025_20250430_WEB.csv" dir
      ON puntaje.RBD = dir.RBD
    LEFT JOIN './data/Postulación_Admisión2026/Oferta académica.csv' oferta
     ON postulacion.COD_CARRERA_PREF = oferta.CODIGO_CARRERA
    LEFT JOIN './data/Postulación_Admisión2026/OFERTA_DEFINITIVA_PROGRAMAS_PAES_2025.csv' ofertaMineduc2025
     ON postulacion.COD_CARRERA_PREF = ofertaMineduc2025.COD_CARRERA
    WHERE
      NOMBRE_UNIVERSIDAD = ${universidad}
      AND LUGAR_IMPARTE = ${lugar}
      AND SITUACION_EGRESO = 1
      AND ESTADO_PREF = 24
    GROUP BY
      NOM_COM_RBD,
      NOMBRE_UNIVERSIDAD,
      LUGAR_IMPARTE
    ORDER BY count(*) DESC
  </script>
  <script id="11" type="application/sql" pinned="" database="duckdb" output="dataPorCarrera">
    SELECT
      COD_CARRERA_PREF,
      NOMBRE_CARRERA,
      NOMBRE_UNIVERSIDAD,
      LUGAR_IMPARTE,
      dir.RBD,
      NOM_RBD,
      NOM_COM_RBD,
      count(*) as estudiantes
    FROM "./data/Rinden_Admisión2026/ArchivoC_Adm2026REG.csv" puntaje
    LEFT JOIN "./data/Postulación_Admisión2026/ArchivoD_Adm2026REG.csv" postulacion
      ON puntaje.ID_aux = postulacion.ID_aux
    LEFT JOIN "./data/Directorio-Oficial-EE-2025/20250926_Directorio_Oficial_EE_2025_20250430_WEB.csv" dir
      ON puntaje.RBD = dir.RBD
    LEFT JOIN './data/Postulación_Admisión2026/Oferta académica.csv' oferta
     ON postulacion.COD_CARRERA_PREF = oferta.CODIGO_CARRERA
    LEFT JOIN './data/Postulación_Admisión2026/OFERTA_DEFINITIVA_PROGRAMAS_PAES_2025.csv' ofertaMineduc2025
     ON postulacion.COD_CARRERA_PREF = ofertaMineduc2025.COD_CARRERA
    WHERE
      COD_CARRERA_PREF = ${carrera.CODIGO_CARRERA}
      AND SITUACION_EGRESO = 1
      AND ESTADO_PREF = 24
    GROUP BY   dir.RBD,
      NOM_RBD,
      NOM_COM_RBD,
      COD_CARRERA_PREF,
      NOMBRE_CARRERA,
      NOMBRE_UNIVERSIDAD,
      LUGAR_IMPARTE
    ORDER BY count(*) DESC
  </script>
  <script id="9" type="text/x-typescript" pinned="">
    const datos = dataPorRBD.filter(d => d.COD_CARRERA_PREF == carrera.COD_CARRERA_PREF)
    display (datos)
  </script>
  <script id="5" type="text/x-typescript">
     /*md`<div style="overflow-x: auto;">
      <table style="border-collapse: collapse; width: 100%; font-family: system-ui, sans-serif;">
        <thead>
          <tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
            <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">RBD</th>
            <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">Nombre Establecimiento</th>
            <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">Comuna</th>
            <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">Código Carrera</th>
            <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">Carrera</th>
            <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">Universidad</th>
            <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">Lugar</th>
            <th style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">Estudiantes</th>
          </tr>
        </thead>
        <tbody>
          ${_.chain(dataPorRBD).map((row, i) => `<tr>
    <tr style="background-color: ${i % 2 === 0 ? '#ffffff' : '#f8f9fa'}; border-bottom: 1px solid #dee2e6;">
              <td style="padding: 8px; border: 1px solid #dee2e6;">${row.RBD}</td>
              <td style="padding: 8px; border: 1px solid #dee2e6;">${row.NOM_RBD || ''}</td>
              <td style="padding: 8px; border: 1px solid #dee2e6;">${row.NOM_COM_RBD || ''}</td>
              <td style="padding: 8px; border: 1px solid #dee2e6;">${row.COD_CARRERA_PREF || ''}</td>
              <td style="padding: 8px; border: 1px solid #dee2e6;">${row.NOMBRE_CARRERA || ''}</td>
              <td style="padding: 8px; border: 1px solid #dee2e6;">${row.NOMBRE_UNIVERSIDAD || ''}</td>
              <td style="padding: 8px; border: 1px solid #dee2e6;">${row.LUGAR_IMPARTE || ''}</td>
              <td style="padding: 8px; text-align: right; border: 1px solid #dee2e6; font-weight: bold;">${row.estudiantes}</td>      </tr>`).value()}
        </tbody>
      </table>
    </div>`*/
  </script>
</notebook>
